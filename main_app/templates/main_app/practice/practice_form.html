{% extends 'base.html' %}
{% load static %}
{% load widget_tweaks %}

{% block head %}
<link rel="stylesheet" href="{% static 'css/form.css' %}" />
{% endblock %}

{% block content %}
<main class="mt-28 px-10 justify-center py-30 text-mono">
  <div class="max-w-6xl mx-auto bg-white/80 rounded-xl shadow-lg p-8 flex flex-col gap-10">

    <header class="text-center">
      {% if test %}
        <h1 class="text-3xl font-bold mb-2">Edit Practice Test: {{ test.title }}</h1>
      {% else %}
        <h1 class="text-3xl font-bold mb-2">Create Your MTEL ELL Practice Test</h1>
      {% endif %}
      <img src="{% static 'images/full_moon.png' %}" alt="A full moon" class="w-20 mx-auto mt-3" />
    </header>

    <div class="flex flex-col justify-between gap-4">

      <!-- SINGLE MASTER FORM -->
      <section class="w-full bg-gray-50 rounded-lg shadow p-6">
        <h2 class="text-xl font-semibold mb-4 text-gray-800">
          Write Your Own Questions or Select Questions for Your Test
        </h2>

        <form method="POST" class="space-y-6">
          {% csrf_token %}

          <!-- Test Title -->
          <div>
            <label for="{{ form.title.id_for_label }}" class="block text-gray-700 font-semibold mb-1">
              Test Title
            </label>
            {{ form.title|add_class:"w-full border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500" }}
          </div>

          <!-- Short Answer Questions -->
          {% if form.short_questions %}
            <div>
              <h3 class="text-lg font-semibold text-gray-700 mb-2">Short Answer Questions</h3>
              <div class="bg-white rounded-md shadow-sm p-3 space-y-2 border border-gray-200 max-h-48 overflow-y-auto">
                {{ form.short_questions }}
              </div>
            </div>
          {% endif %}

          <!-- Long Answer Questions -->
          {% if form.long_questions %}
            <div>
              <h3 class="text-lg font-semibold text-gray-700 mb-2">Long Answer Questions</h3>
              <div class="bg-white rounded-md shadow-sm p-3 space-y-2 border border-gray-200 max-h-48 overflow-y-auto">
                {{ form.long_questions|add_class:"w-full h-64 text-sm leading-snug" }}
              </div>
            </div>
          {% endif %}

          <!-- Multiple Choice Questions -->
          {% if form.mcq_questions %}
            <div class="mb-6">
              <div class="flex justify-between items-center mb-2">
                <h3 class="text-lg font-semibold text-gray-700">Multiple Choice Questions</h3>
                <button id="toggleMcqButton" type="button"
                        class="text-sm bg-blue-100 text-blue-700 px-3 py-1 rounded-md hover:bg-blue-200 transition">
                  Hide
                </button>
              </div>

              <div id="mcqSection" class="bg-white rounded-md shadow-sm p-3 space-y-2 border border-gray-200 max-h-96 overflow-y-auto">
                {% for q in form.fields.mcq_questions.queryset %}
                  <label class="block border rounded-md bg-white p-4 shadow-sm mb-2 hover:bg-gray-50 transition">
                    <input type="checkbox" name="mcq_questions" value="{{ q.id }}" class="mr-2 accent-blue-600">
                    <strong class="text-gray-800">{{ q.prompt }}</strong>
                    <ul class="ml-6 list-disc text-sm text-gray-700 mt-2">
                      <li>A. {{ q.option_a }}</li>
                      <li>B. {{ q.option_b }}</li>
                      <li>C. {{ q.option_c }}</li>
                      <li>D. {{ q.option_d }}</li>
                    </ul>
                  </label>
                {% empty %}
                  <p class="italic text-gray-500">No multiple-choice questions available yet.</p>
                {% endfor %}
              </div>
            </div>
          {% endif %}

          <!--  Inline Add Question Inputs -->
          <hr class="my-6 border-gray-300">

          <!-- Add Multiple Choice -->
          <div class="bg-gray-50 rounded-lg shadow p-6 mb-8">
            <button id="addMcqButton" type="button"
                    class="bg-blue-600 text-white font-semibold py-2 px-4 rounded-md mb-4">
              ‚ûï Add a multiple-choice question
            </button>
            <div id="mcqContainer" class="space-y-4 hidden">
              <div class="mcqForm mcqFormTemplate hidden">
                {{ mcq_form.as_p }}
                <button type="button"
                        class="border border-red-700 text-red-600 rounded px-4 py-3 mcqDeleteButton">
                  üóëÔ∏è Delete
                </button>
              </div>
            </div>
          </div>

          <!-- Add Short Answer -->
          <div class="bg-gray-50 rounded-lg shadow p-6 mb-8">
            <button id="addShortButton" type="button"
                    class="bg-blue-600 text-white font-semibold py-2 px-4 rounded-md mb-4">
              ‚ûï Add a short answer question
            </button>
            <div id="shortContainer" class="space-y-4 hidden">
              <div class="shortForm shortFormTemplate hidden">
                {{ short_form.as_p }}
                <button type="button"
                        class="border border-red-700 text-red-600 rounded px-4 py-3 shortDeleteButton">
                  üóëÔ∏è Delete
                </button>
              </div>
            </div>
          </div>

          <!-- Add Long Answer -->
          <div class="bg-gray-50 rounded-lg shadow p-6 mb-8">
            <button id="addLongButton" type="button"
                    class="bg-blue-600 text-white font-semibold py-2 px-4 rounded-md mb-4">
              ‚ûï Add a long answer question
            </button>
            <div id="longContainer" class="space-y-4 hidden">
              <div class="longForm longFormTemplate hidden">
                {{ long_form.as_p }}
                <button type="button"
                        class="border border-red-700 text-red-600 rounded px-4 py-3 longDeleteButton">
                  üóëÔ∏è Delete
                </button>
              </div>
            </div>
          </div>

          <!-- Save Button -->
          <button type="submit"
                  class="w-full bg-blue-600 text-white font-semibold py-3 rounded-md shadow-md">
            Save Practice Test
          </button>
        </form>
      </section>
    </div>
  </div>
</main>

<!--  JS -->
<script>
document.addEventListener('DOMContentLoaded', () => {
  // Toggle MCQ visibility
  const toggleBtn = document.getElementById('toggleMcqButton');
  const mcqSection = document.getElementById('mcqSection');
  if (toggleBtn && mcqSection) {
    toggleBtn.addEventListener('click', () => {
      mcqSection.style.display =
        mcqSection.style.display === 'none' ? 'block' : 'none';
      toggleBtn.textContent =
        mcqSection.style.display === 'none' ? 'Show' : 'Hide';
    });
  }

  // Utility for cloning new question blocks
  function setupAddButton(btnId, containerId, formClass, deleteClass) {
    const addBtn = document.getElementById(btnId);
    const container = document.getElementById(containerId);
    const template = container.querySelector(`.${formClass}Template`);

    if (!addBtn || !container || !template) return;

    addBtn.addEventListener('click', () => {
      container.style.display = 'block';
      const newForm = template.cloneNode(true);
      newForm.classList.remove(`${formClass}Template`, 'hidden');
      newForm.querySelectorAll('input, textarea, select').forEach(el => el.value = '');
      container.appendChild(newForm);
    });

    container.addEventListener('click', e => {
      if (e.target.classList.contains(deleteClass)) {
        e.preventDefault();
        e.target.closest(`.${formClass}`).remove();
      }
    });
  }

  setupAddButton('addMcqButton', 'mcqContainer', 'mcqForm', 'mcqDeleteButton');
  setupAddButton('addShortButton', 'shortContainer', 'shortForm', 'shortDeleteButton');
  setupAddButton('addLongButton', 'longContainer', 'longForm', 'longDeleteButton');
});
</script>

{% endblock %}
