{% extends 'base.html' %}
{% load static %}

{% block head %}
<link rel="stylesheet" href="{% static 'css/practice_test_list.css' %}">
{% endblock %}

{% block content %}
<section class="max-w-xl mx-auto p-6 space-y-4 text-black mt-20 py-20 justify-center">
  <h1 class="text-2xl text-white text-mono font-semibold text-center mb-4">Take the Test</h1>

  <form action="{% url 'practice-take' practice_test_id=practice_test.id %}" method="post">
    {% csrf_token %}

    <!-- Multiple Choice -->
     {%if mcq_questions.exists %}
    <h2 class="text-lg font-bold mt-8 text-white">Multiple Choice</h2>
    {% for mcq in mcq_questions %}
     <div id="question-{{forloop.counter}}" class="question mcq-question hidden border border-gray-300 p-4 mb-4 rounded-md bg-black text-mono text-black">


        <p class="font-medium text-black text-mono font-semibold">{{ mcq.prompt }}</p>

        <ul class="space-y-2 pl-4">
            <li><label><strong>A.</strong> <input type="radio" name="mcq_question_{{ mcq.id }}" value="A"> {{ mcq.option_a }}</label></li>
            <li><label><strong>B.</strong> <input type="radio" name="mcq_question_{{ mcq.id }}" value="B"> {{ mcq.option_b }}</label></li>
            <li><label><strong>C.</strong> <input type="radio" name="mcq_question_{{ mcq.id }}" value="C"> {{ mcq.option_c }}</label></li>
            <li><label><strong>D.</strong> <input type="radio" name="mcq_question_{{ mcq.id }}" value="D"> {{ mcq.option_d }}</label></li>
          </ul>

      </div>
    {% endfor %}
    {% endif %}
    

    <!-- Short Answer -->
     {% if short_questions.exists %}
    <h2 class="text-lg font-bold mt-8 text-white">Short Answer</h2>
    {% for short in short_questions %}
      <div id="question-{{ forloop.counter|add:mcq_count}}" class="question hidden border-gray-300 p-4 mb-4 rounded-md bg-white text-white text-mono">
        <p class="font-medium text-white text-mono font-semibold">{{ short.prompt }}</p>
        <textarea name="short_question_{{ short.id }}" class="border rounded-md p-2 text-black w-full mt-2" rows="2"></textarea>
      </div>
    {% endfor %}
    {% endif %}

    <!-- Long Answer -->
     {% if long_questions.exists %}
    <h2 class="text-lg bg-slate-800 font-bold mt-8 text-white p-2 rounded-md text-mono text-white text-2xl">Long Answer</h2>
    {% for long in long_questions %}
      <div id="question-{{ forloop.counter|add:mcq_count|add:short_count}}" class="question hidden border border-gray-300 bg-gray-200 p-4 mb-4 rounded-md text-black text-2xl">
        <p class="font-medium text-black mb-2">{{ long.prompt }}</p>
        <textarea 
          name="long_question_{{ long.id }}" 
          class="border border-gray-400 rounded-md p-2 w-full mt-2 bg-gray-50 focus:bg-white focus:outline-none focus:ring-2 focus:ring-slate-500 text-black"
          rows="4"></textarea>
      </div>
    {% endfor %}
    {% endif %}


     <button class="w-full bg-blue-600 text-white font-semibold py-3 rounded-md shadow-md" type="button"  data-qnum="1" data-test="{{ practice_test.id }}" id="next">Next</button>

 
<script>
  const isAuthenticated = {{ user.is_authenticated|yesno:"true,false" }};
</script>




<script>

  function showItem(id) {
  document.querySelectorAll('.question').forEach(el => el.classList.add('hidden'));
  document.getElementById(id).classList.remove('hidden');
}

  const nextButton = document.getElementById('next');

  nextButton.addEventListener('click',async () => {
    if (!nextButton) return;

    const qNum= parseInt(nextButton.dataset.qnum)+1
    const testId=nextButton.dataset.test

    const res= await fetch(`/practice/${testId}/next/${qNum}/`);
    console.log("Fetching next question:", res.url, res.status);
    const data= await res.json();

    if(!data.done){
      nextButton.dataset.qnum=data.q_num
    }if(qNum<=data.total){
      showItem(`question-${qNum}`);
    }else{
      {% if user.is_authenticated %}
      nextButton.textContent="Submit Test";
      nextButton.type="submit";
      {% else %}
      alert("Please log in to submit your test.");
      window.location.href = "{% url 'login' %}";
      {% endif %}
    }
  
  });
  showItem('question-1');
</script>

<script>
  async function checkAnswer(questionId, selectedChoice) {
    const response = await fetch(`/practice/check_answer/${questionId}/?choice=${selectedChoice}`);
    const data = await response.json();
    console.log("check_answer returned:", data); // ðŸ‘€ debug line
    return data; // return the full response object
  }

  document.querySelectorAll('input[type="radio"]').forEach(radio => {
  radio.addEventListener('change', async (event) => {
    const questionContainer = event.target.closest('.question');
    const inputs = questionContainer.querySelectorAll('input[type="radio"]');

    // disable all radios in this question
    inputs.forEach(input => input.disabled = true);

    const questionId = event.target.name.split('_').pop();
    const selectedChoice = event.target.value;

    const data = await checkAnswer(questionId, selectedChoice);

    const labels = questionContainer.querySelectorAll('label');

    const correctLabel = [...labels].find(l => {
      const input = l.querySelector('input');
      return input && input.value === data.correct_label;
    });

    const selectedLabel = [...labels].find(l => {
      const input = l.querySelector('input');
      return input && input.value === selectedChoice;
    });

    // clear previous highlights
    labels.forEach(label => label.classList.remove('correct-answer', 'wrong-answer'));

    if (data.is_correct) {
      if (correctLabel) correctLabel.classList.add('correct-answer');
    } else {
      if (selectedLabel) selectedLabel.classList.add('wrong-answer');
      if (correctLabel) correctLabel.classList.add('correct-answer');
    }

    const feedback = document.createElement('p');
    feedback.classList.add('mt-2', 'font-semibold');

    if (data.is_correct) {
      feedback.innerHTML = `<img src="{% static 'images/2714_color.png' %}" 
  alt="Correct" class="feedback-icon inline w-3 h-3 mr-1 align-middle"> Correct answer!`;
      feedback.classList.add('text-green-500');
    } else {
      feedback.innerHTML = `<img src="{% static 'images/274C_color.png' %}" 
  alt="Incorrect" class="feedback-icon inline w-3 h-3 mr-1 align-middle"> 
  Incorrect answer. The correct answer is <b>${data.correct_label}. ${data.correct_text}</b>`;
      feedback.classList.add('text-red-500');
    }

    questionContainer.appendChild(feedback);
  });
});

</script>

<style>
  .correct-answer {
  background-color: #22c55e33; /* soft green tint */
  border-radius: 6px;
  padding: 4px;
}

.wrong-answer {
  background-color: #ef444433; /* soft red tint */
  border-radius: 6px;
  padding: 4px;
}

img.feedback-icon {
  width: 18px;
  height: 18px;
  object-fit: contain;
}

.mcq-question {
  background-color: #e8f9fd;
  color: black;
  border-color: #444;
}

</style>

  {% endblock %}