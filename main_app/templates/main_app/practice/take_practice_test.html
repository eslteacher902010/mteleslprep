{% extends 'base.html' %}
{% load static %}

{% block head %}
<style>
  .fade-in { animation: fadeIn 0.3s ease-in; }
  @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
  
  /* HIGH SPECIFICITY SELECTORS TO OVERRIDE TAILWIND */
  body .option-label.correct-highlight { 
    background-color: #dcfce7 !important; 
    border: 2px solid #22c55e !important; 
    color: #166534 !important; 
  }
  
  body .option-label.wrong-highlight { 
    background-color: #fee2e2 !important; 
    border: 2px solid #ef4444 !important; 
    color: #991b1b !important; 
  }
  
  .option-label { 
    transition: all 0.2s; 
    cursor: pointer; 
    display: flex;
    align-items: center;
    padding: 12px; 
    border-radius: 8px; 
    border: 1px solid #e5e7eb; 
    background-color: white;
    margin-bottom: 8px;
  }
  .option-label:hover { background-color: #f9fafb; border-color: #3b82f6; }
  input:disabled + span, input:disabled { opacity: 0.9; cursor: not-allowed; }

  /* Change radio dial color when highlighted */
  .correct-highlight input { accent-color: #22c55e; }
  .wrong-highlight input { accent-color: #ef4444; }
</style>
{% endblock %}

{% block content %}
<section class="max-w-2xl mx-auto p-6 mt-10">
  <div class="mb-8">
    <div class="flex justify-between items-center mb-2">
      <h1 class="text-xl font-bold text-gray-800">{{ practice_test.title|default:"Practice Test" }}</h1>
      <span id="progress-text" class="text-sm font-medium text-blue-600">Question 1 of {{ total_questions }}</span>
    </div>
    <div class="w-full bg-gray-200 h-2 rounded-full overflow-hidden">
      <div id="progress-bar" class="bg-blue-600 h-full transition-all duration-500" style="width: 0%"></div>
    </div>
  </div>

  <form id="test-form" action="{% url 'practice-take' practice_test_id=practice_test.id %}" method="post">
    {% csrf_token %}

    <div id="question-display-area" class="bg-white rounded-xl shadow-lg p-8 min-h-[400px]">
      {% for q in all_questions %}
        <div class="question-unit hidden" id="q-{{ forloop.counter }}" data-id="{{ q.id }}" data-type="{% if q.option_a %}mcq{% elif q.sample_answer %}long{% else %}short{% endif %}">
          
          {% if q.option_a %} 
            <span class="inline-block px-3 py-1 rounded-full bg-blue-100 text-blue-800 text-xs font-bold mb-4">MULTIPLE CHOICE</span>
            <p class="text-lg font-semibold text-gray-900 mb-6">{{ q.prompt }}</p>
            
            <div class="grid gap-3">
                {% for choice_val, choice_text in q.get_options_list %} 
                <label class="option-label" style="background-image: none !important;">
                  <input type="radio" name="mcq_question_{{ q.id }}" value="{{ choice_val|upper }}" class="mr-3 w-4 h-4 accent-blue-600">
                  <span><span class="font-bold mr-1">{{ choice_val }}.</span> {{ choice_text }}</span>
                </label>
                {% endfor %}
            </div>

          {% else %} 
            <span class="inline-block px-3 py-1 rounded-full bg-purple-100 text-purple-800 text-xs font-bold mb-4">WRITTEN RESPONSE</span>
            <p class="text-lg font-semibold text-gray-900 mb-6">{{ q.prompt }}</p>
            <textarea 
              name="{% if q.sample_answer %}long{% else %}short{% endif %}_question_{{ q.id }}" 
              class="w-full border border-gray-300 p-3 rounded-lg focus:ring-2 focus:ring-blue-500 focus:outline-none text-black mb-4" 
              rows="5" 
              placeholder="Type your answer here..."></textarea>
            
            <button type="button" class="check-written-btn text-sm font-bold text-blue-600 hover:text-blue-800 underline" data-id="{{ q.id }}">
              Show Correct Answer
            </button>
          {% endif %}
          
          <div class="feedback-container mt-6"></div>
        </div>
      {% endfor %}
    </div>

    <div class="flex justify-between items-center mt-8">
      <button type="button" id="prev-btn" class="px-6 py-2 text-gray-600 font-medium hidden hover:text-blue-600">Previous</button>
      <button type="button" id="next-btn" class="ml-auto bg-blue-600 hover:bg-blue-700 text-white px-8 py-3 rounded-lg font-bold shadow-lg transition-all active:scale-95">
        Next Question
      </button>
    </div>
  </form>
</section>

<script>
  const state = {
    currentIdx: 1,
    total: Number("{{ total_questions|default:0 }}"), 
    testId: "{{ practice_test.id }}"
  };

  const nextBtn = document.getElementById('next-btn');
  const prevBtn = document.getElementById('prev-btn');
  const progressBar = document.getElementById('progress-bar');
  const progressText = document.getElementById('progress-text');

  function updateUI() {
    const questions = document.querySelectorAll('.question-unit');
    questions.forEach(q => q.classList.add('hidden'));
    
    const currentQ = document.getElementById(`q-${state.currentIdx}`);
    if (currentQ) {
      currentQ.classList.remove('hidden');
      currentQ.classList.add('fade-in');
    }

    const percent = state.total > 0 ? (state.currentIdx / state.total) * 100 : 0;
    progressBar.style.width = `${percent}%`;
    progressText.innerText = `Question ${state.currentIdx} of ${state.total}`;

    prevBtn.classList.toggle('hidden', state.currentIdx === 1);
    nextBtn.innerText = (state.currentIdx === state.total) ? "Finish & Submit" : "Next Question";
    nextBtn.classList.toggle('bg-green-600', state.currentIdx === state.total);
    nextBtn.classList.toggle('bg-blue-600', state.currentIdx !== state.total);
  }

  // Handle MCQ Highlighting
  document.querySelectorAll('input[type="radio"]').forEach(input => {
    input.addEventListener('change', async (e) => {
      const selectedInput = e.target;
      const selectedLabel = selectedInput.closest('.option-label');
      const questionUnit = selectedInput.closest('.question-unit');
      const questionId = questionUnit.dataset.id;
      const qType = questionUnit.dataset.type;
      const feedbackArea = questionUnit.querySelector('.feedback-container');

      // Disable inputs so they can't change their answer
      const allInputs = questionUnit.querySelectorAll('input[type="radio"]');
      allInputs.forEach(i => i.disabled = true);

      try {
        const res = await fetch(`/practice/check_answer/${questionId}/?choice=${selectedInput.value}&type=${qType}`);
        const data = await res.json();

        if (data.is_correct) {
          // FORCE GREEN INLINE
          selectedLabel.style.cssText = "background-color: #dcfce7 !important; border: 2px solid #22c55e !important; color: #166534 !important;";
        } else {
          // FORCE RED INLINE
          selectedLabel.style.cssText = "background-color: #fee2e2 !important; border: 2px solid #ef4444 !important; color: #991b1b !important;";
          
          // FIND AND FORCE GREEN ON THE CORRECT ONE
          const serverAnswer = data.correct_answer.trim().toUpperCase();
          const correctInput = Array.from(allInputs).find(i => i.value.trim().toUpperCase() === serverAnswer);
          
          if (correctInput) {
            correctInput.closest('.option-label').style.cssText = "background-color: #dcfce7 !important; border: 2px solid #22c55e !important; color: #166534 !important;";
          }
        }

        feedbackArea.innerHTML = `
          <div class="p-4 bg-slate-50 border-l-4 border-blue-500 fade-in rounded mt-4">
            <p class="text-xs font-bold text-blue-600 uppercase mb-1">Rationale</p>
            <p class="text-sm text-gray-700">${data.explanation || 'No explanation provided.'}</p>
          </div>`;
      } catch (err) { console.error(err); }
    });
  });

  // Handle Written Logic
  document.querySelectorAll('.check-written-btn').forEach(btn => {
    btn.addEventListener('click', async (e) => {
      const questionUnit = e.target.closest('.question-unit');
      const questionId = questionUnit.dataset.id;
      const qType = questionUnit.dataset.type;
      const feedbackArea = questionUnit.querySelector('.feedback-container');

      try {
        const res = await fetch(`/practice/check_answer/${questionId}/?type=${qType}`);
        const data = await res.json();
        feedbackArea.innerHTML = `
          <div class="p-4 bg-green-50 border-l-4 border-green-500 fade-in rounded">
            <p class="text-xs font-bold text-green-600 uppercase mb-1">Correct Answer / Sample</p>
            <p class="text-sm text-gray-800 mb-2">${data.correct_answer || 'N/A'}</p>
            <p class="text-xs font-bold text-blue-600 uppercase mb-1">Rationale</p>
            <p class="text-sm text-gray-700">${data.explanation || 'N/A'}</p>
          </div>`;
        e.target.remove();
      } catch (err) { console.error(err); }
    });
  });

  nextBtn.addEventListener('click', () => {
    if (state.currentIdx < state.total) { state.currentIdx++; updateUI(); }
    else { document.getElementById('test-form').submit(); }
  });

  prevBtn.addEventListener('click', () => { if (state.currentIdx > 1) { state.currentIdx--; updateUI(); } });

  updateUI();
</script>
{% endblock %}